<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head runat="server">
    <meta charset="utf-8"/>
    <title>Business cards - The sample page - Customer's Canvas</title>

    <script type="text/javascript" src="http://code.jquery.com/jquery-2.1.1.min.js">
    </script>
    <!-- IFrame API 스크립트 -->
    <script id="CcIframeApiScript"
            type="text/javascript"
            src="{{ IframeApi }}">
    </script>

    <script>
        $(function () {
            // 제품 정의
            let productDefinition = {
                surfaces: [
                    {
                        "printAreas": [{
                            "designFile": "samples/businesscard/test-11",
                            "designLocation": {
                                "X": "36",
                                "Y": "36"
                            }
                        }],
                        "mockup": {
                            "down": "samples/mockup1"
                        }
                    },
                    {
                        "printAreas": [{
                            "designFile": "samples/businesscard/test-12",
                            "designLocation": {
                                "X": "36",
                                "Y": "36"
                            }
                        }],
                        "mockup": {
                            "down": "samples/mockup1"
                        }
                    }
                ]
            };

            //Defining the editor configuration.
            let configuration = {widgets: {FinishButton: {mode: "Disabled"}}};

            let editorFrame = $("#editorFrame");

            let editor = null;

            function handleError(error, message) {
                console.error(message, error);
                return error;
            }

            let loadData = null;

            //Loading a product into the editor.
            CustomersCanvas.IframeApi.loadEditor(editorFrame[0], productDefinition, configuration)
                //If the editor has been successfully loaded.
                .then(function (e) {
                    editor = e;
                })
                //If there was an error thrown when loading the editor.
                .catch(function (error) {
                    loadData = handleError(error, "Load failed with exception: ");
                });

            let currentPage = "design";

            //Object containing data generated by getProofImages.
            let approveData = null;

            //Object containing data generated by finishProductDesign.
            let renderData = null;

            //Object containing data generated by saveProduct.
            let saveData = null;

            //Saving the product.
            $("#editorPage #saveButton").click(function () {

                editor.saveProduct()
                    //If the product has been successfully saved.
                    .then(function (result) {
                        //Saving the product state info.
                        saveData = result;
                        console.log(result);
                    })
                    //If there was an error thrown when saving the product.
                    .catch(function (error) {
                        saveData = handleError(error, "Save failed with exception: ");
                    });
            });

            //Getting links to proof images.
            $("#editorPage #nextButton").click(function () {

                editor.getProofImages()
                    //If proof images have been successfully received.
                    .then(function (result) {
                        //Saving proof images info.
                        approveData = result;
                        console.log(result);

                        //Go to the approval page.
                        goToPage("approve");
                    })
                    //If there was an error thrown while getting the proof images.
                    .catch(function (error) {
                        approveData = handleError(error, "Getting proof images failed with exception: ");
                    });
            });

            //Finishing the product customization.
            $("#approvePage #approveButton").click(function () {

                editor.finishProductDesign()
                    //If the product customization has been successfully completed.
                    .then(function (result) {
                        //Saving hi-res output info.
                        renderData = result;
                        console.log(result);

                        //Go to the finish page.
                        goToPage("finish");
                    })
                    //If there was an error thrown while finishing the product customization.
                    .catch(function (error) {
                        renderData = handleError(error, "Product customization completion failed with exception: ");
                    });
            });

            //Opening a new product in the designer.
            $("#finishOrderPage #newDesign").click(function () {
                editor.revertProduct();
                goToPage("design");
            });

            //Reopening the product in the designer.
            $("#approvePage #lnkEditAgain").click(function () {
                goToPage("design");
            });

            //Initializing the approval and finish pages with the product info.

            //Initializing the approval page with links to the proof images.
            function setApprovePageData() {
                let previewElements = $("#approvePage .previewImg").attr("src", "");
                for (let i = 0; i < approveData.proofImageUrls.length && i < previewElements.length; i++) {
                    previewElements[i].setAttribute("src", approveData.proofImageUrls[i]);
                }
            }

            //Initializing the finish page with the print-ready output URL and a link for reopening the product in the designer for further editing.
            function setFinishPageData() {
                $("#finishOrderPage #hiResLink").attr("href", renderData.hiResOutputUrls[0]);
            }

            //The wizard navigation.

            function goToPage(to) {
                setupPage(to);
            }

            window.onpopstate = function (e) {
                setupPage(e.state);
            }

            let workflowPages = {
                "design": {elements: $("#editorPage")},
                "approve": {elements: $("#approvePage"), setData: setApprovePageData},
                "finish": {elements: $("#finishOrderPage"), setData: setFinishPageData}
            }

            function setupPage(page) {
                let destPageData = workflowPages[page];

                if (typeof destPageData.setData === "function")
                    destPageData.setData();

                workflowPages[currentPage].elements.fadeOut(function () {
                    destPageData.elements.show();

                    currentPage = page;
                });
            }
        })
    </script>
</head>

<body>
<div id="wrapper">
    <div id="content">
        <!-- The design page -->
        <div id="editorPage">
            <div id="iframeWrapper">
                <iframe id="editorFrame" width="100%" height="800px"></iframe>
            </div>
            <div id="saveAndNextButtonsWrapper">
                <!-- 저장 버튼 -->
                <input id="saveButton" type="button" value="저장"/>
                <!-- 디자인 완료 버튼 -->
                <input id="nextButton" type="button" value="디자인 완료 >"/>
            </div>
        </div>

        <!-- 승인 페이지 -->
        <div id="approvePage" style="display: none">
            <div>
                <h1>Approve Your Product</h1>
                <!-- 검증 이미지 -->
                <img id="preview"/>
                <img id="previewPage2"/>
            </div>
            <p>
            <div id="approveButtonWrapper">
                <input id="approveButton" type="button" value="승인 >"/>
            </div>
            </p>
            <div>
                <a id="lnkEditAgain">&lt; I want to make some changes</a>
            </div>
        </div>

        <!-- 디자인 완료 페이지 -->
        <div id="finishOrderPage" style="display: none">
            <h1>Your Product is Ready</h1>
            <!-- 고해상도 출력 다운로드 링크 -->
            The print-ready file can be downloaded from <a id="hiResLink">this link</a>
            <div>
                <input id="newDesign" type="button" value="< 새로운 디자인"/>
            </div>
        </div>
    </div>
</div>
</body>
</html>