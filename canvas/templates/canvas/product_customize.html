<!DOCTYPE html>
{% load static %}
<html xmlns="http://www.w3.org/1999/xhtml">
<head runat="server">
    <meta charset="utf-8"/>
    <title>Business cards - The sample page - Customer's Canvas</title>

    <script type="text/javascript" src="http://code.jquery.com/jquery-2.1.1.min.js">
    </script>
    <link href="{% static 'css/canvas/index.css' %}" rel="stylesheet"/>
    <!-- The IFrame API script. IMPORTANT! Do not remove or change the ID. -->
    <script id="CcIframeApiScript"
            type="text/javascript"
            src="{{ IframeApi }}">
    </script>

    <script>
        $(function () {
            //Defining the product.
            let productDefinition = {
                surfaces: [
                    {
                        "printAreas": [{
                            "designFile": "samples/businesscard/test-11",

                        }],
                        "previewMockup": {
                            "down": "samples/mockup1"
                        }
                    },
                    {
                        "printAreas": [{
                            "designFile": "samples/businesscard/test-12",

                        }],
                        "previewMockup": {
                            "down": "samples/mockup1"
                        }
                    }
                ]
            };

            //Defining the editor configuration.
            var configuration = {widgets: {FinishButton: {mode: "Disabled"}}};

            var editorFrame = $("#editorFrame");

            var editor = null;

            function handleError(error, message) {
                console.error(message, error);
                return error;
            };

            var loadData = null;

            //Loading a product into the editor.
            CustomersCanvas.IframeApi.loadEditor(editorFrame[0], productDefinition, configuration)
                //If the editor has been successfully loaded.
                .then(function (e) {
                    editor = e;
                })
                //If there was an error thrown when loading the editor.
                .catch(function (error) {
                    loadData = handleError(error, "Load failed with exception: ");
                });

            var currentPage = "design";

            //Object containing data generated by getProofImages.
            var approveData = null;

            //Object containing data generated by finishProductDesign.
            var renderData = null;

            //Object containing data generated by saveProduct.
            var saveData = null;

            //Saving the product.
            $("#editorPage #saveButton").click(function () {

                editor.saveProduct()
                    //If the product has been successfully saved.
                    .then(function (result) {
                        //Saving the product state info.
                        saveData = result;
                    })
                    //If there was an error thrown when saving the product.
                    .catch(function (error) {
                        saveData = handleError(error, "Save failed with exception: ");
                    });
            });

            //Getting links to proof images.
            $("#editorPage #nextButton").click(function () {

                editor.getProofImages()
                    //If proof images have been successfully received.
                    .then(function (result) {
                        //Saving proof images info.
                        approveData = result;

                        //Go to the approval page.
                        goToPage("approve");
                    })
                    //If there was an error thrown while getting the proof images.
                    .catch(function (error) {
                        approveData = handleError(error, "Getting proof images failed with exception: ");
                    });
            });

            //Finishing the product customization.
            $("#approvePage #approveButton").click(function () {

                editor.finishProductDesign()
                    //If the product customization has been successfully completed.
                    .then(function (result) {
                        //Saving hi-res output info.
                        renderData = result;

                        //Go to the finish page.
                        goToPage("finish");
                    })
                    //If there was an error thrown while finishing the product customization.
                    .catch(function (error) {
                        renderData = handleError(error, "Product customization completion failed with exception: ");
                    });
            });

            //Opening a new product in the designer.
            $("#finishOrderPage #newDesign").click(function () {
                editor.revertProduct();
                goToPage("design");
            });

            //Reopening the product in the designer.
            $("#approvePage #lnkEditAgain").click(function () {
                goToPage("design");
            });

            //Initializing the approval and finish pages with the product info.

            //Initializing the approval page with links to the proof images.
            function setApprovePageData() {
                var previewElements = $("#approvePage .previewImg").attr("src", "");
                for (var i = 0; i < approveData.proofImageUrls.length && i < previewElements.length; i++) {
                    previewElements[i].setAttribute("src", approveData.proofImageUrls[i]);
                }
            };

            //Initializing the finish page with the print-ready output URL and a link for reopening the product in the designer for further editing.
            function setFinishPageData() {
                $("#finishOrderPage #hiResLink").attr("href", renderData.hiResOutputUrls[0]);
            };

            //The wizard navigation.

            function goToPage(to) {
                setupPage(to);
            }

            window.onpopstate = function (e) {
                setupPage(e.state);
            }

            var workflowPages = {
                "design": {elements: $("#editorPage")},
                "approve": {elements: $("#approvePage"), setData: setApprovePageData},
                "finish": {elements: $("#finishOrderPage"), setData: setFinishPageData}
            }

            function setupPage(page) {
                var destPageData = workflowPages[page];

                if (typeof destPageData.setData === "function")
                    destPageData.setData();

                workflowPages[currentPage].elements.fadeOut(function () {
                    destPageData.elements.show();

                    currentPage = page;
                });
            }
        })
    </script>
</head>

<body>
<div id="wrapper">
    <div id="content">
        <!-- The design page -->
        <div id="editorPage" class="area">
            <div id="iframeWrapper">
                <iframe id="editorFrame" width="100%" height="800px"></iframe>
            </div>
            <div id="saveAndNextButtonsWrapper">
                <!-- The Save button -->
                <input id="saveButton" type="button" class="btn btn-info btn-lg" value="Save"/>
                <!-- The Finish design button -->
                <input id="nextButton" type="button" class="btn btn-success btn-lg" value="Finish design >"/>
            </div>
        </div>

        <!-- The approval page -->
        <div id="approvePage" class="area" style="display: none">
            <div class="container-fluid">
                <h1>Approve Your Product</h1>
                <!-- proof images -->
                <img class="previewImg" id="preview"/>
                <img class="previewImg" id="previewPage2"/>
            </div>
            <p>
            <div id="approveButtonWrapper">
                <input id="approveButton" type="button" class="btn btn-success btn-lg" value="Approve >"/>
            </div>
            </p>
            <div class="return">
                <a id="lnkEditAgain">&lt; I want to make some changes</a>
            </div>
        </div>

        <!-- The finish page -->
        <div id="finishOrderPage" class="area" style="display: none">
            <h1 class="">Your Product is Ready</h1>
            <!-- The link for downloading the hi-res output. -->
            The print-ready file can be downloaded from <a id="hiResLink">this link</a>
            <div class="right">
                <input id="newDesign" type="button" class="btn btn-info btn-lg" value="< New design"/>
            </div>
        </div>
    </div>
</div>
</body>
</html>